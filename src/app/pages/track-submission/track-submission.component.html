<div class="track-submission-container">
  <div class="page-header">
    <h1>{{ 'trackSubmission.title' | translate }}</h1>
    <p>{{ 'trackSubmission.subtitle' | translate }}</p>
  </div>

  <!-- Search Section -->
  <nz-card class="search-section">
    <nz-tabset (nzSelectedIndexChange)="onTabChange($event)">
      <!-- Track by ID -->
      <nz-tab [nzTitle]="'trackSubmission.byTrackingId' | translate">
        <div class="search-form">
          <div class="search-input-group">
            <input nz-input
              [(ngModel)]="trackingId"
              [placeholder]="'trackSubmission.trackingIdPlaceholder' | translate"
              (keyup.enter)="searchByTrackingId()"
              class="search-input" />
            <button nz-button
              nzType="primary"
              [nzLoading]="isLoading"
              (click)="searchByTrackingId()">
              <span nz-icon nzType="search" nzTheme="outline"></span>
              {{ 'trackSubmission.search' | translate }}
            </button>
          </div>
          <div class="search-hint">
            {{ 'trackSubmission.trackingIdHint' | translate }}
          </div>
        </div>
      </nz-tab>

      <!-- Track by Email -->
      <nz-tab [nzTitle]="'trackSubmission.byEmail' | translate">
        <div class="search-form">
          <div class="search-input-group">
            <input nz-input
              type="email"
              [(ngModel)]="email"
              [placeholder]="'trackSubmission.emailPlaceholder' | translate"
              (keyup.enter)="searchByEmail()"
              class="search-input" />
            <button nz-button
              nzType="primary"
              [nzLoading]="isLoading"
              (click)="searchByEmail()">
              <span nz-icon nzType="search" nzTheme="outline"></span>
              {{ 'trackSubmission.search' | translate }}
            </button>
          </div>
          <div class="search-hint">
            {{ 'trackSubmission.emailHint' | translate }}
          </div>
        </div>
      </nz-tab>
    </nz-tabset>
  </nz-card>

  <!-- Error Message -->
  @if (error) {
    <nz-alert
      nzType="error"
      [nzMessage]="error"
      nzShowIcon
      class="error-alert">
    </nz-alert>
  }

  <!-- Loading -->
  @if (isLoading) {
    <div class="loading-container">
      <nz-spin nzSimple></nz-spin>
    </div>
  }

  <!-- Single Submission Result -->
  @if (submission && searchMode === 'tracking') {
    <nz-card class="result-card">
      <div class="result-header">
        <div class="tracking-id">{{ submission.tracking_id }}</div>
        <nz-tag class="status-tag" [nzColor]="getStatusColor(submission.status)">
          <span nz-icon [nzType]="getStatusIcon(submission.status)" nzTheme="outline"></span>
          {{ submission.status_display }}
        </nz-tag>
      </div>
      <nz-divider></nz-divider>
      <div class="result-content">
        <div class="app-info">
          <div class="app-info-header">
            <img
              [src]="submission.app_icon_url || 'https://itqan.dev/images/home/hero-card-mushaf.svg'"
              [alt]="getAppName(submission)"
              class="app-icon"
              />
            <div class="app-name-container">
              <h2 class="app-name">{{ getAppName(submission) }}</h2>
              @if (currentLang === 'en') {
                <p class="app-name-secondary">{{ submission.app_name_ar }}</p>
              }
              @if (currentLang === 'ar') {
                <p class="app-name-secondary">{{ submission.app_name_en }}</p>
              }
            </div>
          </div>
        </div>
        @if (submission.message) {
          <div class="status-message">
            <nz-alert
              class="status-alert"
              [nzType]="submission.status === 'approved' ? 'success' : (submission.status === 'rejected' ? 'error' : 'info')"
              [nzMessage]="submission.message"
              nzShowIcon>
            </nz-alert>
          </div>
        }
        <div class="dates">
          <div class="date-item">
            <span class="date-label">{{ 'trackSubmission.submittedOn' | translate }}:</span>
            <span class="date-value">{{ formatDate(submission.submitted_at) }}</span>
          </div>
          @if (submission.reviewed_at) {
            <div class="date-item">
              <span class="date-label">{{ 'trackSubmission.reviewedOn' | translate }}:</span>
              <span class="date-value">{{ formatDate(submission.reviewed_at) }}</span>
            </div>
          }
        </div>
        <!-- App Link if Approved -->
        @if (submission.app_url) {
          <div class="app-link-section">
            <nz-divider></nz-divider>
            <a [href]="submission.app_url" nz-button nzType="primary" nzSize="large">
              <span nz-icon nzType="link" nzTheme="outline"></span>
              {{ 'trackSubmission.viewAppListing' | translate }}
            </a>
          </div>
        }
      </div>
    </nz-card>
  }

  <!-- Multiple Submissions List (by email) -->
  @if (submissions.length > 0 && searchMode === 'email') {
    <div class="submissions-list">
      <h3>{{ 'trackSubmission.foundSubmissions' | translate }}: {{ submissions.length }}</h3>
      @for (item of submissions; track item) {
        <nz-card class="submission-item" (click)="selectSubmission(item)">
          <div class="item-header">
            <span class="item-tracking-id">{{ item.tracking_id }}</span>
            <nz-tag [nzColor]="getStatusColor(item.status)">
              {{ item.status_display }}
            </nz-tag>
          </div>
          <div class="item-content">
            <div class="item-app-name">{{ getAppName(item) }}</div>
            <div class="item-date">{{ formatDate(item.submitted_at) }}</div>
          </div>
        </nz-card>
      }
    </div>
  }

  <!-- No Results (email search) -->
  @if (!isLoading && searchMode === 'email' && email && submissions.length === 0 && !error) {
    <nz-empty
      [nzNotFoundContent]="'trackSubmission.noSubmissions' | translate">
    </nz-empty>
  }

  <!-- Submit New App Link -->
  <div class="submit-link">
    <p>{{ 'trackSubmission.wantToSubmit' | translate }}</p>
    <a [routerLink]="['/', currentLang, 'submit-app']" nz-button nzType="default">
      {{ 'trackSubmission.submitNewApp' | translate }}
    </a>
  </div>
</div>
