name: Run Django Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run migrations on'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
  push:
    branches:
      - develop
      - staging
      - main
    paths:
      - 'backend/apps/migrations/**'
      - 'backend/categories/migrations/**'
      - 'backend/developers/migrations/**'

jobs:
  migrate:
    name: Run Migrations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV=${{ github.event.inputs.environment }}
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="production"
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            ENV="staging"
          else
            ENV="development"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "Running migrations on: $ENV"

      - name: Setup SSH for development
        if: steps.env.outputs.environment == 'development'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_DEV }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST_DEV }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Setup SSH for staging
        if: steps.env.outputs.environment == 'staging'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_STAGING }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST_STAGING }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Setup SSH for production
        if: steps.env.outputs.environment == 'production'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_PROD }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST_PROD }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Run migrations on development
        if: steps.env.outputs.environment == 'development'
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER_DEV }}@${{ secrets.SSH_HOST_DEV }} << 'ENDSSH'
          set -e
          echo "üì¶ Pulling latest code from develop branch..."
          cd /var/www/quran-apps-backend || exit 1
          git config --global --add safe.directory /var/www/quran-apps-backend
          git fetch origin develop
          git checkout develop
          git pull origin develop

          echo "üîÑ Running database migrations..."
          source venv/bin/activate 2>/dev/null || exit 1
          python3 manage.py migrate --noinput

          echo "‚úÖ Migrations completed successfully"
          python3 manage.py showmigrations | grep -E "^\s*\[" | head -20
          ENDSSH

      - name: Run migrations on staging
        if: steps.env.outputs.environment == 'staging'
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER_STAGING }}@${{ secrets.SSH_HOST_STAGING }} << 'ENDSSH'
          set -e
          echo "üì¶ Pulling latest code from staging branch..."
          cd /var/www/quran-apps-backend || exit 1
          git config --global --add safe.directory /var/www/quran-apps-backend
          git fetch origin staging
          git checkout staging
          git pull origin staging

          echo "üîÑ Running database migrations..."
          source venv/bin/activate 2>/dev/null || exit 1
          python3 manage.py migrate --noinput

          echo "‚úÖ Migrations completed successfully"
          python3 manage.py showmigrations | grep -E "^\s*\[" | head -20
          ENDSSH

      - name: Run migrations on production
        if: steps.env.outputs.environment == 'production'
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER_PROD }}@${{ secrets.SSH_HOST_PROD }} << 'ENDSSH'
          set -e
          echo "‚ö†Ô∏è  PRODUCTION MIGRATION INITIATED"
          echo "üì¶ Pulling latest code from main branch..."
          cd /var/www/quran-apps-backend || exit 1
          git config --global --add safe.directory /var/www/quran-apps-backend
          git fetch origin main
          git checkout main
          git pull origin main

          echo "üíæ Creating database backup..."
          mkdir -p backups
          BACKUP_FILE="backups/db_backup_$(date +%Y%m%d_%H%M%S).sql"
          pg_dump -h localhost -U postgres -d quran_apps_db > "$BACKUP_FILE" 2>/dev/null || echo "Note: Backup may require additional setup"

          echo "üîÑ Running database migrations..."
          source venv/bin/activate 2>/dev/null || exit 1
          python3 manage.py migrate --noinput

          echo "‚úÖ Migrations completed successfully"
          python3 manage.py showmigrations | grep -E "^\s*\[" | head -20

          echo "üöÄ Service restart (manual if needed)"
          ENDSSH

      - name: Verify migrations
        if: success()
        run: echo "‚úÖ All migrations completed successfully!"

      - name: Notify failure
        if: failure()
        run: echo "‚ùå Migration failed. Please check the logs above."
        continue-on-error: true
