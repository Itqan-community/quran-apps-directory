name: Deploy to Development Environment (DO)

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt

    - name: Clean development database
      run: |
        echo "ðŸ§¹ Cleaning development database..."
        # This step will run on the DO server via SSH
        # We'll use the cleanup script we created

    - name: Deploy to Digital Ocean
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        port: ${{ secrets.DO_PORT }}
        script: |
          cd /var/www/quran-apps-backend/backend

          # Pull latest changes
          git pull origin develop

          # Clean database before migrations
          python manage.py shell << 'EOF'
          from apps.models import App
          from categories.models import Category

          print('Cleaning development database...')
          app_count = App.objects.count()
          cat_count = Category.objects.count()
          print(f'Deleting {app_count} apps and {cat_count} categories...')
          App.objects.all().delete()
          Category.objects.all().delete()
          print('âœ… Database cleaned!')
          EOF

          # Reset migrations to clean state
          python manage.py migrate apps 0001
          python manage.py migrate categories 0001

          # Run migrations
          echo "ðŸš€ Running migrations..."
          python manage.py migrate

          # Collect static files
          python manage.py collectstatic --noinput

          # Restart services
          sudo systemctl reload gunicorn
          sudo systemctl reload nginx

          echo "âœ… Deployment completed successfully!"

    - name: Verify deployment
      run: |
        echo "â³ Waiting for services to start..."
        sleep 30

        echo "ðŸ” Verifying API endpoints..."
        curl -f https://dev.api.quran-apps.itqan.dev/api/categories/ || echo "Categories API not ready yet"
        curl -f https://dev.api.quran-apps.itqan.dev/api/apps/ || echo "Apps API not ready yet"

        echo "âœ… Deployment verification completed!"