# Railway Configuration for Quran Apps Directory
# This configuration ensures proper deployment of both frontend and backend services

[build]
builder = "docker"

[deploy]
healthcheckPath = "/"
healthcheckTimeout = 300
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 10

# Frontend Service Configuration
[[services]]
name = "quran-frontend"
source = "."
dockerfilePath = "Dockerfile"
dockerfileTarget = "production"

[services.variables]
NODE_ENV = "production"
PORT = "3000"
NG_APP_API_BASE_URL = "${{ services.quran-backend-api.publicUrl }}/api"
NG_APP_SITE_DOMAIN = "${{ publicDomain }}"
NG_APP_ENABLE_DARK_MODE = "true"
NG_APP_ENABLE_ANALYTICS = "false"
NG_APP_FORCE_HTTPS = "true"
NG_APP_ENABLE_SERVICE_WORKER = "false"

[services.variables]
# Set CSP via environment variable for Railway
CSP_HEADER = "default-src 'self'; base-uri 'self'; img-src 'self' data: blob: https:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: blob:; script-src-elem 'self' 'unsafe-inline' https: blob:; font-src 'self' data: https:; connect-src 'self' https:; media-src 'self' https:; object-src 'none'; frame-src 'self' https:;"
X_FRAME_OPTIONS = "SAMEORIGIN"
X_CONTENT_TYPE_OPTIONS = "nosniff"
X_XSS_PROTECTION = "1; mode=block"
REFERRER_POLICY = "strict-origin-when-cross-origin"

[services.headers]
# Fallback CSP headers (simpler format)
Content-Security-Policy = "default-src 'self'; base-uri 'self'; img-src 'self' data: blob: https:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: blob:; font-src 'self' data: https:; connect-src 'self' https:; media-src 'self' https:; object-src 'none'; frame-src 'self' https:;"
X-Frame-Options = "SAMEORIGIN"
X-Content-Type-Options = "nosniff"
X-XSS-Protection = "1; mode=block"
Referrer-Policy = "strict-origin-when-cross-origin"

[services.healthcheck]
path = "/"
port = 3000

# Backend API Service Configuration
[[services]]
name = "quran-backend-api"
builder = "docker"
source = "backend"
dockerfilePath = "backend/Dockerfile"
dockerfileTarget = "production"

[services.variables]
DJANGO_SETTINGS_MODULE = "config.settings.production"
PYTHONUNBUFFERED = "1"
PYTHONDONTWRITEBYTECODE = "1"
DEBUG = "False"
SECRET_KEY = "${{ secrets.DJANGO_SECRET_KEY }}"
DB_ENGINE = "django.db.backends.postgresql"
DB_NAME = "quran_apps_db"
DB_USER = "postgres"
DB_PASSWORD = "${{ services.quran-postgres.POSTGRES_PASSWORD }}"
DB_HOST = "${{ services.quran-postgres.host }}"
DB_PORT = "${{ services.quran-postgres.port }}"
DB_SSLMODE = "prefer"
ALLOWED_HOSTS = "${{ publicDomain }},railway.app"
CORS_ALLOWED_ORIGINS = "https://dev.quran-apps.itqan.dev"
SECURE_SSL_REDIRECT = "True"
SESSION_COOKIE_SECURE = "True"
CSRF_COOKIE_SECURE = "True"
WHITENOISE_COMPRESS = "True"
WHITENOISE_COMPRESSION_QUALITY = "85"
WHITENOISE_AUTOREFRESH = "False"

[services.headers]
# CORS and security headers for API
Access-Control-Allow-Origin = "https://dev.quran-apps.itqan.dev"
Access-Control-Allow-Methods = "GET, POST, PUT, PATCH, DELETE, OPTIONS"
Access-Control-Allow-Headers = "Content-Type, Authorization, X-Requested-With, Accept, Origin, Access-Control-Request-Method, Access-Control-Request-Headers, X-API-Version"
Access-Control-Allow-Credentials = "true"
X-Frame-Options = "DENY"
X-Content-Type-Options = "nosniff"
X-XSS-Protection = "1; mode=block"
Referrer-Policy = "strict-origin-when-cross-origin"

[services.healthcheck]
path = "/api/categories/"
port = 8000

[services.dependencies]
[services.dependencies.services]
quran-postgres = "service_healthy"

# PostgreSQL Database Service Configuration
[[services]]
name = "quran-postgres"
image = "postgres:15-alpine"

[services.variables]
POSTGRES_DB = "quran_apps_db"
POSTGRES_USER = "postgres"
POSTGRES_PASSWORD = "${{ secrets.POSTGRES_PASSWORD }}"
POSTGRES_INITDB_ARGS = "--encoding=UTF8 --locale=C"

[services.healthcheck]
command = "pg_isready -U postgres -d quran_apps_db"
interval = 30
timeout = 10
retries = 3
startPeriod = 60

[services.volumes]
[services.volumes.data]
path = "/var/lib/postgresql/data"
