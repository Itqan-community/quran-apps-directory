# <!-- Powered by BMAD™ Core -->
# Story 1.1: Core API Foundation

## Status
Draft

## Story
**As a** user,
**I want to** browse all available apps with pagination, filtering by category, and search functionality,
**so that** I can discover Quranic applications that meet my needs.

## Acceptance Criteria
1. List all apps with pagination (20 apps per page)
2. Filter apps by category slug
3. Search apps by name (English and Arabic)
4. Get app details with all related information
5. API responses should include proper HTTP status codes
6. All endpoints should be accessible without authentication (public read access)
7. Include OpenAPI documentation for all endpoints

## Tasks / Subtasks
- [ ] Task 1: Setup Django project structure (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Create Django project with proper settings configuration
  - [ ] Install required packages (Django, DRF, drf-spectacular, psycopg2)
  - [ ] Configure database connection to PostgreSQL
  - [ ] Setup environment-based settings (local, staging, production)
  - [ ] Create apps directory structure (apps, core, config)
  - [ ] Run initial migrations

- [ ] Task 2: Implement core models (AC: 1, 2, 3, 4)
  - [ ] Create BaseModel with timestamps
  - [ ] Create PublishedModel with status field
  - [ ] Implement App model with all required fields
  - [ ] Implement Category model
  - [ ] Implement Developer model
  - [ ] Create model relationships (FK and M2M)
  - [ ] Add database indexes for performance
  - [ ] Run migrations to create tables

- [ ] Task 3: Create DRF serializers (AC: 1, 2, 3, 4, 5)
  - [ ] Create base serializers in core app
  - [ ] Implement CategorySerializer
  - [ ] Implement DeveloperSerializer
  - [ ] Implement AppListSerializer (for list view)
  - [ ] Implement AppDetailSerializer (for detail view)
  - [ ] Add proper validation and field constraints

- [ ] Task 4: Implement API endpoints (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create AppViewSet with ModelViewSet
  - [ ] Implement list view with pagination
  - [ ] Implement filtering by category
  - [ ] Implement search functionality
  - [ ] Implement retrieve view for app details
  - [ ] Configure URL routing
  - [ ] Set proper permission classes (IsAuthenticatedOrReadOnly)

- [ ] Task 5: Setup OpenAPI documentation (AC: 7)
  - [ ] Configure drf-spectacular settings
  - [ ] Add schema information to views
  - [ ] Create API documentation endpoint
  - [ ] Test OpenAPI schema generation

- [ ] Task 6: Add sample data and testing (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create Django management command to load sample apps
  - [ ] Load sample data from existing applicationsData.ts
  - [ ] Test all endpoints with curl/Postman
  - [ ] Verify pagination works correctly
  - [ ] Verify filtering and search functionality

- [ ] Task 7: Performance and caching (AC: 1, 2, 3, 4)
  - [ ] Add select_related and prefetch_related optimizations
  - [ ] Implement basic caching for app lists
  - [ ] Add cache invalidation on app updates
  - [ ] Monitor query performance

## Dev Notes

### Database Schema
Based on the System Architecture document, we need to implement the following core tables:

**Apps table structure:**
- id (UUID, Primary Key)
- name_en, name_ar (VARCHAR, required)
- short_description_en, short_description_ar (TEXT)
- description_en, description_ar (TEXT)
- slug (SLUG, unique, indexed)
- status (CHOICE: draft/published/archived, indexed)
- avg_rating (DECIMAL 3,2, default 0.00, indexed)
- review_count (INTEGER, default 0)
- view_count (INTEGER, default 0)
- application_icon (URL, nullable)
- main_image_en, main_image_ar (URL, nullable)
- google_play_link, app_store_link, app_gallery_link (URL, nullable)
- sort_order (INTEGER, nullable)
- created_at, updated_at (TIMESTAMP)
- developer_id (FK to developers table, indexed)
- categories (M2M to categories table)

[Source: SYSTEM-ARCHITECTURE.md#Core Entities & Relationships]

### API Endpoints Structure
The following endpoints need to be implemented:

```
GET    /api/v1/apps                    # List all apps (paginated, filterable)
GET    /api/v1/apps?category={slug}    # Filter by category
GET    /api/v1/apps?search={query}     # Full-text search
GET    /api/v1/apps/{id}               # Get app detail
GET    /api/v1/categories              # List categories
GET    /api/v1/categories/{id}         # Get category detail
GET    /api/v1/developers              # List developers
GET    /api/v1/developers/{id}         # Get developer profile
```

[Source: SYSTEM-ARCHITECTURE.md#API Endpoint Structure]

### Technology Stack
- **Backend:** Django 5.2 with Django REST Framework 3.15
- **Database:** PostgreSQL 15+
- **Authentication:** Not required for public endpoints
- **Documentation:** drf-spectacular for OpenAPI 3.0
- **Caching:** Django-redis (optional for this story)

[Source: django-architecture-supplement.md#Technology Stack]

### Project Structure
```
quran_apps_directory/
├── quran_apps/                # Django project
│   ├── settings/
│   │   ├── base.py           # Base settings
│   │   ├── local.py          # Local development
│   │   └── production.py     # Production settings
│   └── urls.py               # Main URL config
├── apps/                     # Apps Django app
│   ├── models.py             # App model
│   ├── serializers.py        # DRF serializers
│   ├── views.py              # API views
│   └── urls.py               # App URLs
├── categories/               # Categories Django app
├── developers/               # Developers Django app
├── core/                     # Shared functionality
│   ├── models.py             # Base models
│   ├── pagination.py         # Custom pagination
│   └── permissions.py        # Permissions
└── manage.py
```

[Source: django-architecture-supplement.md#Project Structure]

### Model Implementation Notes
- Use BaseModel for created_at/updated_at fields
- Use PublishedModel for status management
- App model should inherit from PublishedModel
- Use UUID for primary keys
- Implement __str__ methods for all models
- Add proper Meta classes with ordering and indexes

[Source: django-architecture-supplement.md#Django Models Implementation]

### Serializer Implementation Notes
- Use different serializers for list vs detail views
- Implement proper field validation
- Use ReadOnlyField for computed fields like rating_display
- Include related objects (developer, categories) in responses

[Source: django-architecture-supplement.md#DRF Serializers]

### ViewSet Implementation Notes
- Use ModelViewSet for full CRUD operations
- Implement custom get_queryset for filtering/search
- Use select_related/prefetch_related for query optimization
- Set permission_classes = [IsAuthenticatedOrReadOnly]
- Implement pagination with 20 items per page

[Source: django-architecture-supplement.md#DRF Views and ViewSets]

### Performance Considerations
- Add indexes on frequently queried fields
- Use select_related for FK relationships
- Use prefetch_related for M2M relationships
- Consider caching for popular endpoints
- Monitor query performance with Django Debug Toolbar

[Source: SYSTEM-ARCHITECTURE.md#Query Patterns & Performance]

### Testing
- Test files should be in each app's tests.py
- Test all endpoints with various scenarios
- Test pagination edge cases
- Test filtering and search functionality
- Test invalid requests and error responses

### Environment Variables
Required environment variables:
- SECRET_KEY
- DB_NAME, DB_USER, DB_PASSWORD, DB_HOST, DB_PORT
- DEBUG (default: False)
- DJANGO_SETTINGS_MODULE (config.settings.local for development)

[Source: django-architecture-supplement.md#Environment Variables Template]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Shell ID 21f3ba: Django development server testing
- Shell ID f8bcc5: API endpoint validation and testing

### Completion Notes List
1. **Django Project Setup**: Successfully created modular Django project with environment-based settings (base/local/production)
2. **PostgreSQL in Docker**: Configured PostgreSQL to run in Docker container for local development (NOT SQLite)
3. **Core Models Implementation**: Implemented BaseModel and PublishedModel with UUID primary keys, timestamps, and proper relationships
4. **Database Schema**: Created 7 tables with 20+ indexes for optimal query performance
5. **API Endpoints**: Implemented 15+ API endpoints with full CRUD support, filtering, search, and pagination
6. **OpenAPI Documentation**: Configured drf-spectacular with comprehensive API documentation at /api/docs/
7. **Sample Data**: Created management command and loaded 5 sample apps with categories and developers
8. **Performance Optimizations**: Added database indexes, query optimization (select_related/prefetch_related), and caching system
9. **Testing**: All endpoints tested successfully with proper HTTP status codes and JSON responses
10. **dev-start.sh Update**: Updated script to start full stack (PostgreSQL in Docker + Backend + Frontend)

### Technical Implementation Details
- **Backend Framework**: Django 4.2.25 LTS with Django REST Framework 3.16.1
- **Database**: PostgreSQL in Docker for local development (REQUIRED) and PostgreSQL in production
- **Authentication**: Session-based with IsAuthenticatedOrReadOnly permissions
- **Pagination**: Custom pagination class with 20 items per page
- **Filtering**: Category, platform, featured status, and full-text search in English/Arabic
- **Caching**: In-memory cache with automatic invalidation on data changes
- **Documentation**: OpenAPI 3.0 spec with Swagger UI and ReDoc

### File List
**Core Configuration:**
- `/backend/requirements.txt` - Python dependencies
- `/backend/.env` - Environment variables for development
- `/backend/quran_apps/settings/base.py` - Base Django settings
- `/backend/quran_apps/settings/local.py` - Development settings
- `/backend/quran_apps/settings/production.py` - Production settings
- `/backend/quran_apps/urls.py` - Main URL configuration

**Models:**
- `/backend/core/models.py` - BaseModel and PublishedModel abstract classes
- `/backend/apps/models.py` - App model with relationships and methods
- `/backend/categories/models.py` - Category model with slug and ordering
- `/backend/developers/models.py` - Developer model with verification status

**API Layer:**
- `/backend/core/pagination.py` - Custom pagination implementation
- `/backend/apps/serializers.py` - App serializers (list/detail/create)
- `/backend/categories/serializers.py` - Category serializers
- `/backend/developers/serializers.py` - Developer serializers
- `/backend/apps/views.py` - App ViewSet with filtering, search, and caching
- `/backend/categories/views.py` - Category ViewSet
- `/backend/developers/views.py` - Developer ViewSet

**URL Routing:**
- `/backend/apps/urls.py` - App endpoint routing
- `/backend/categories/urls.py` - Category endpoint routing
- `/backend/developers/urls.py` - Developer endpoint routing

**Management Commands:**
- `/backend/apps/management/commands/create_sample_data.py` - Sample data loader

### API Endpoints Implemented
```
GET    /api/v1/apps/              # List apps (paginated, filterable, searchable)
GET    /api/v1/apps/{id}/         # App detail (supports UUID and slug)
GET    /api/v1/apps/featured/     # Featured apps (with caching)
GET    /api/v1/apps/by-platform/  # Apps by platform
GET    /api/v1/categories/        # List categories
GET    /api/v1/categories/{id}/   # Category detail
GET    /api/v1/developers/        # List developers
GET    /api/v1/developers/{id}/   # Developer profile
GET    /api/schema/               # OpenAPI schema
GET    /api/docs/                 # Swagger UI
GET    /api/redoc/                # ReDoc
```

### Performance Features
- **Database Indexes**: 20+ indexes on frequently queried fields
- **Query Optimization**: select_related/prefetch_related for optimal joins
- **Caching**: 10-minute cache for featured apps with automatic invalidation
- **Pagination**: Efficient pagination with metadata
- **Filtering**: Database-level filtering with proper indexing

## QA Results
*To be populated by QA Agent*