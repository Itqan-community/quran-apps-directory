# Railway deployment - uses $PORT environment variable
:{$PORT:3000} {
	# Serve the Angular build from dist/browser
	root * dist/browser
	file_server

	# Enable compression
	encode zstd gzip

	# SPA fallback so deep links work
	try_files {path} /index.html

	# Security headers including CSP with blob support for Angular
	header {
		# Hide server header
		-Server

		# Content Security Policy - permits blob: scripts and workers for Angular
		Content-Security-Policy "default-src 'self' https:; script-src 'self' https: blob: 'unsafe-inline' 'unsafe-eval'; script-src-elem 'self' https: blob: 'unsafe-inline'; worker-src 'self' blob:; connect-src 'self' https: wss:; img-src 'self' https: data: blob:; style-src 'self' https: 'unsafe-inline'; font-src 'self' https: data:; object-src 'none'; base-uri 'self'; frame-ancestors 'self' https:; media-src 'self' https:;"

		# Other security headers
		Referrer-Policy "strict-origin-when-cross-origin"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1; mode=block"
		Permissions-Policy "geolocation=(), microphone=(), camera=()"
	}

	# Cache control for static assets
	@static {
		path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot *.avif *.webp *.webmanifest
	}
	header @static Cache-Control "public, max-age=31536000, immutable"

	# Service Worker - no cache to always get updates
	@sw path /sw.js /ngsw-worker.js /ngsw.json
	header @sw Cache-Control "no-cache, must-revalidate"

	# Health check endpoint
	@health path /health
	respond @health 200 "healthy\n"
}